{{/* Esporta tutte le config presenti in data/maps come oggetto JS,
     poi scegli quella giusta in base allo slug/candidati della pagina. */}}

<!-- OpenLayers JS (globale: window.ol) -->
<script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>

<script>
  // 1) Esporta tutte le config YAML disponibili
  window.__DATA_MAPS__ = {
  {{- $first := true -}}
  {{- range $k, $v := site.Data.maps -}}
    {{- if not $first }},{{ end -}}
    {{ $first = false -}}
    {{ $k | jsonify }}: {{ $v | jsonify }}
  {{- end -}}
  };

  // 2) Candidati per lo slug della pagina corrente
  (function() {
    try {
      var candidates = [];

      // Valori iniettati da Hugo
      var pSlug   = {{ with .Params.slug }}{{ . | jsonify }}{{ else }}null{{ end }};
      var fTBase  = {{ with .File }}{{ .TranslationBaseName | jsonify }}{{ else }}null{{ end }};
      var fBase   = {{ with .File }}{{ .BaseFileName | jsonify }}{{ else }}null{{ end }};
      var sect    = {{ .Section | jsonify }};
      var title   = {{ .Title | jsonify }};

      if (pSlug)  candidates.push(pSlug);
      if (fTBase) candidates.push(fTBase);
      if (fBase)  candidates.push(fBase);

      function urlize(s){ return (s||"").toString().trim().toLowerCase().replace(/\s+/g,'-'); }
      candidates = candidates.concat(candidates.map(urlize));

      var dataMaps = window.__DATA_MAPS__ || {};
      var picked = null, pickedKey = null;
      for (var i=0; i<candidates.length; i++) {
        var k = candidates[i];
        if (k && dataMaps.hasOwnProperty(k)) { picked = dataMaps[k]; pickedKey = k; break; }
      }

      if (sect === "maps" && !picked && dataMaps.hasOwnProperty("test")) {
        picked = dataMaps["test"]; pickedKey = "test";
      }

      if (!picked) {
        console.warn("[scripts] Nessuna config trovata per", candidates, "— __MAP_CONFIG__ sarà {}");
        window.__MAP_CONFIG__ = {};
      } else {
        console.log("[scripts] Config risolta:", pickedKey, picked);
        window.__MAP_CONFIG__ = picked;
      }

      window.__MAP_TITLE__ = title;
      window.__MAP_SLUG__  = pSlug || fTBase || fBase || "";
    } catch(e){
      console.error("[scripts] Errore preparando __MAP_CONFIG__:", e);
      window.__MAP_CONFIG__ = {};
    }
  })();
</script>

{{/* CSS e JS core condivisi */}}
{{ $corecss := resources.Get "css/ol_custom.css" }}
{{ $mapcss  := resources.Get "css/map.css" }}
<link rel="stylesheet" href="{{ $corecss.RelPermalink }}">
<link rel="stylesheet" href="{{ $mapcss.RelPermalink }}">

{{ $core := resources.Get "js/map-core.js" }}
{{ $init := resources.Get "js/map-init.js" }}
<script src="{{ $core.RelPermalink }}?v={{ now.Unix }}"></script>
<script src="{{ $init.RelPermalink }}?v={{ now.Unix }}"></script>

{{/* === PER-MAPPA: dalla stessa cartella di index.md (page bundle) === */}}
{{ $slugGuess := "" }}
{{ if .Params.slug }}
  {{ $slugGuess = .Params.slug }}
{{ else if .File }}
  {{ $slugGuess = or .File.TranslationBaseName .File.BaseFileName }}
{{ end }}

{{/* CSS specifici: prima "map*.css", poi "<slug>.css" */}}
{{ with .Resources.GetMatch "map*.css" }}
  <link rel="stylesheet" href="{{ .RelPermalink }}?v={{ now.Unix }}">
{{ end }}
{{ if $slugGuess }}
  {{ with .Resources.GetMatch (printf "%s.css" $slugGuess) }}
    <link rel="stylesheet" href="{{ .RelPermalink }}?v={{ now.Unix }}">
  {{ end }}
{{ end }}

{{/* JS specifici: prima "map*.js", poi "<slug>.js" */}}
{{ with .Resources.GetMatch "map*.js" }}
  <script src="{{ .RelPermalink }}?v={{ now.Unix }}"></script>
{{ end }}
{{ if $slugGuess }}
  {{ with .Resources.GetMatch (printf "%s.js" $slugGuess) }}
    <script src="{{ .RelPermalink }}?v={{ now.Unix }}"></script>
  {{ end }}
{{ end }}
