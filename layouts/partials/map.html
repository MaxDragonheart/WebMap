<div class="map-wrapper">
  <div id="map" class="map"></div>

  {{ if .Config.controls.slider }}
  <div class="map-slider">
    <label for="opacity">Opacità raster</label>
    <input id="opacity" type="range" min="0" max="1" step="0.05"
           value="{{ if .Config.raster.opacity }}{{ .Config.raster.opacity }}{{ else }}1{{ end }}">
  </div>
  {{ end }}

  {{ if .Config.popup.enabled }}
  <div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
  </div>
  {{ end }}

  <!-- BOX COORDINATE: ALTO CENTRO -->
  <div class="map-top-center" id="map-coords">
    <span class="coord-label">Lon:</span>
    <span id="lon-value" class="coord-value">—</span>
    <span class="sep">|</span>
    <span class="coord-label">Lat:</span>
    <span id="lat-value" class="coord-value">—</span>
  </div>

  <!-- Basemap: bottone icona + pannello a scomparsa (alto destra) -->
  <div class="map-basemap" id="bm-root">
    <button type="button" id="bm-btn" class="bm-btn" aria-label="Basemap">
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path d="M12 3L1 9l11 6 11-6-11-6zm0 8L1 5v4l11 6 11-6V5l-11 6zm0 4L1 11v4l11 6 11-6v-4l-11 4z" fill="currentColor"/>
      </svg>
    </button>
    <div class="bm-panel" id="bm-panel" hidden>
      <div class="bm-title">Basemap</div>
      <ul class="bm-list" id="bm-list"></ul>
    </div>
  </div>

  <!-- Misure: bottone righello + pannello a scomparsa (sinistra, metà altezza) -->
  <div class="map-measure" id="ms-root">
    <button type="button" id="ms-btn" class="ms-btn" aria-label="Misure">
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11zm2.92 1.83H5.5v-1.42l1.5-1.5 1.42 1.42-1.5 1.5zm2.83-2.83L7.33 14.5l1.5-1.5 1.42 1.42-1.5 1.5zm2.83-2.83l-1.42-1.42 1.5-1.5 1.42 1.42-1.5 1.5zm2.83-2.83l-1.42-1.42 1.5-1.5 1.42 1.42-1.5 1.5z" fill="currentColor"/>
      </svg>
    </button>
    <div class="ms-panel" id="ms-panel" hidden>
      <div class="ms-title">Strumenti di misura</div>
      <div class="ms-actions">
        <button type="button" id="ms-line"  class="ms-action">Distanza</button>
        <button type="button" id="ms-area"  class="ms-action">Area</button>
      </div>
      <div class="ms-sep"></div>
      <button type="button" id="ms-clear" class="ms-clear">Cancella misure</button>
    </div>
  </div>
</div>

<script>
  window.__MAP_CONFIG__ = {{ .Config | jsonify }};
  document.addEventListener("DOMContentLoaded", function(){
    const map = window.createMap(window.__MAP_CONFIG__, "map", {
      popupContainerId: "popup",
      popupCloserId: "popup-closer",
      popupContentId: "popup-content",
      opacitySliderId: "opacity"
    });

    // Coordinate live
    if (map && window.getMouseCoordinates) {
      window.getMouseCoordinates(map, "lon-value", "lat-value");
    }

    // Basemap panel (toggle + radio)
    (function(){
      const root  = document.getElementById("bm-root");
      const btn   = document.getElementById("bm-btn");
      const panel = document.getElementById("bm-panel");
      window.initBasemapPanel && window.initBasemapPanel("bm-list", window.__MAP_CONFIG__, function(){
        panel.hidden = true; root.classList.remove("open");
      });
      btn.addEventListener("click", function(e){
        e.stopPropagation();
        const willOpen = panel.hidden;
        panel.hidden = !willOpen;
        root.classList.toggle("open", willOpen);
      });
      document.addEventListener("click", function(e){
        if (!root.contains(e.target)) { panel.hidden = true; root.classList.remove("open"); }
      });
    })();

    // Measure panel (tutto gestito da initMeasureUI)
    window.initMeasureUI && window.initMeasureUI(map, {
      rootId: "ms-root",
      toggleBtnId: "ms-btn",
      panelId: "ms-panel",
      btnLineId: "ms-line",
      btnAreaId: "ms-area",
      btnClearId: "ms-clear"
    });
  });
</script>
