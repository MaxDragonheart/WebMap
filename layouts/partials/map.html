<div class="map-wrapper">
  <div id="map" class="map"></div>

  {{ if .Config.controls.slider }}
  <div class="map-slider">
    <label for="opacity">Opacità raster</label>
    <input id="opacity" type="range" min="0" max="1" step="0.05"
           value="{{ if .Config.raster.opacity }}{{ .Config.raster.opacity }}{{ else }}1{{ end }}">
  </div>
  {{ end }}

  {{ if .Config.popup.enabled }}
  <div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
  </div>
  {{ end }}

  <!-- BOX COORDINATE: ALTO CENTRO -->
  <div class="map-top-center" id="map-coords">
    <span class="coord-label">Lon:</span>
    <span id="lon-value" class="coord-value">—</span>
    <span class="sep">|</span>
    <span class="coord-label">Lat:</span>
    <span id="lat-value" class="coord-value">—</span>
  </div>

  <!-- BASemap UI: bottone icona + pannello -->
  <div class="map-basemap" id="bm-root">
    <button type="button" id="bm-btn" class="bm-btn" aria-label="Basemap">
      <!-- icona layer (inline SVG, no dipendenze) -->
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path d="M12 3L1 9l11 6 11-6-11-6zm0 8L1 5v4l11 6 11-6V5l-11 6zm0 4L1 11v4l11 6 11-6v-4l-11 4z" fill="currentColor"/>
      </svg>
    </button>
    <div class="bm-panel" id="bm-panel" hidden>
      <div class="bm-title">Basemap</div>
      <ul class="bm-list" id="bm-list"></ul>
    </div>
  </div>
</div>

<script>
  window.__MAP_CONFIG__ = {{ .Config | jsonify }};
  document.addEventListener("DOMContentLoaded", function(){
    const map = window.createMap(window.__MAP_CONFIG__, "map", {
      popupContainerId: "popup",
      popupCloserId: "popup-closer",
      popupContentId: "popup-content",
      opacitySliderId: "opacity"
    });

    // Coordinate live
    if (map && window.getMouseCoordinates) {
      window.getMouseCoordinates(map, "lon-value", "lat-value");
    }

    // Inizializza pannello basemap
    const root = document.getElementById("bm-root");
    const btn  = document.getElementById("bm-btn");
    const panel = document.getElementById("bm-panel");

    if (window.initBasemapPanel) {
      window.initBasemapPanel("bm-list", window.__MAP_CONFIG__, function(){
        // chiudi pannello dopo la selezione
        panel.hidden = true;
        root.classList.remove("open");
      });
    }

    // toggle pannello
    btn.addEventListener("click", function (e) {
      e.stopPropagation();
      const willOpen = panel.hidden;
      document.querySelectorAll(".bm-panel").forEach(p => { p.hidden = true; });
      document.querySelectorAll(".map-basemap").forEach(r => r.classList.remove("open"));
      panel.hidden = !willOpen;
      root.classList.toggle("open", willOpen);
    });

    // click fuori: chiudi
    document.addEventListener("click", function (e) {
      if (!root.contains(e.target)) {
        panel.hidden = true;
        root.classList.remove("open");
      }
    });
  });
</script>
